let IMEMode="toHiragana";const itemsPerPage=25;let currentPage=1,data=[],filteredData=[];function loadContent(){return fetch("content-min.json").then((e=>e.json())).then((e=>{data=e,filteredData=data,loadPage(currentPage)}))}function getPageData(e){const t=25*(e-1),n=t+25;return filteredData.slice(t,n)}function loadPage(e){const t=generateContentHTML(getPageData(e));document.getElementById("container").innerHTML=t,updatePaginationControls(e),highlightFirstExerciseNumbers(),initializeNotes(),setInitialFuriganaState(),updateCounter()}function changePage(e){currentPage=e,""===document.getElementById("search").value.trim()?loadPage(currentPage):searchFunction(),updatePaginationControls(currentPage)}function generateContentHTML(e){const t=[];return e.forEach((e=>{let n=`<div class="number" id="${e.id}">`;e.counter&&(n+=`<span class="counter">${e.counter}</span>`),e.kanjiHeader&&(n+=`<span class="kanjiHeader">${e.kanjiHeader}</span>`),n+="</div>\n";let a='<div class="exercise">\n';e.kanjiHeader?a+=`<div class="sentence first elem_${e.kanjiHeader}">${e.exercise.sentence}</div>\n`:a+=`<div class="sentence">${e.exercise.sentence}</div>\n`,e.exercise.translation&&(a+=`<div class="translation">${e.exercise.translation}</div>\n`),e.exercise.notes&&e.exercise.notes.length>0&&(a+='<div class="notes">\n',e.exercise.notes.forEach((e=>{e=e.replace(/「(.*?)」/g,'「<span class="grammarPointsNote">$1</span>」'),a+=`<div class="note">${e}</div>\n`})),a+="</div>\n"),a+=`<a href="kanjistudy://grs?id=${e.id}">View in Kanji Study</a>`,a+=`<div class="exerciseNumber">${e.id}</div>\n`,a+="</div>\n",t.push(n+a)})),t.join("")}function updatePaginationControls(e){const t=Math.ceil(filteredData.length/25),n=document.getElementById("paginationControls");n.innerHTML="";for(let a=1;a<=t;a++){const t=document.createElement("button");t.textContent=a,a===e?(t.classList.add("active"),t.disabled=!0):t.disabled=!1,t.addEventListener("click",(()=>changePage(a))),n.appendChild(t)}}function setupPage(){highlightFirstExerciseNumbers(),updateCounter(),setInitialFuriganaState()}function highlightFirstExerciseNumbers(){const e=document.querySelectorAll(".exercise .sentence.first");for(const t of e){t.parentElement.previousElementSibling.classList.add("colouredNumber")}}window.onload=function(){loadContent().then(setupPage).catch((e=>{})),initializeEventListeners()};let exerciseTotalNumber=null;function updateCounter(){const e=filteredData.length;document.getElementById("filteredNumber").innerText=e}function initializeNotes(){const e=document.getElementsByClassName("notes");for(const t of e){const e=t.innerHTML;t.setAttribute("data-original-text",e),t.innerHTML="Show notes"}}function setInitialFuriganaState(){const e=document.getElementsByClassName("sentence");for(const t of e){const e=t.getElementsByTagName("rt");for(const t of e)t.style.visibility="hidden"}}function initializeEventListeners(){document.getElementById("toggleMode").addEventListener("click",(function(){document.body.classList.toggle("dark-mode"),document.body.classList.contains("dark-mode"),this.innerHTML='<i class="fa-solid fa-lightbulb"></i>'})),document.getElementById("container").addEventListener("click",toggleVisibility),document.getElementById("useFurigana").addEventListener("change",handleCheckboxChange),document.getElementById("useTranslation").addEventListener("change",handleCheckboxChange),document.getElementById("useLessons").addEventListener("change",searchFunction),document.getElementById("search").addEventListener("input",debounceSearch),bindIME(),handleCheckboxChange()}const numberMapping={1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十"};let debounceTimer,reverseNumberMapping={};for(let e in numberMapping)reverseNumberMapping[numberMapping[e]]=e;function replaceNumbers(e){let t=e;return Object.keys(numberMapping).forEach((e=>{const n=numberMapping[e];t=t.replace(new RegExp(`\\b${e}\\b`,"g"),n)})),Object.keys(reverseNumberMapping).forEach((e=>{const n=reverseNumberMapping[e];t=t.replace(new RegExp(`\\b${e}\\b`,"g"),n)})),t}function prepareTextForSearch(e){const t=replaceNumbers(e);return{original:t,hiragana:wanakana.toHiragana(t),katakana:wanakana.toKatakana(t)}}function debounceSearch(){clearTimeout(debounceTimer),debounceTimer=setTimeout(searchFunction,300)}function debounceKanjiSearch(){clearTimeout(debounceTimer),debounceTimer=setTimeout(kanjiSearchFunction,300)}function searchFunction(){const e=document.getElementById("search").value.trim();if(/^\s*$/.test(e))return filteredData=data,void loadPage(1);const t=[e].map((e=>prepareTextForSearch(replaceNumbers(e)))),n=document.getElementById("useFurigana").checked,a=document.getElementById("useKanji").checked,i=document.getElementById("useTranslation").checked,o=document.getElementById("useLessons").checked;if(a&&debounceKanjiSearch(),o)return void displayChapter(data);filteredData=[];let s=0;data.forEach((r=>{const c=document.createElement("div");c.innerHTML=r.exercise.sentence;const l=replaceNumbers(c.textContent.toLowerCase()),d=replaceNumbers(r.exercise.translation.toLowerCase());let u="";if(n){const e=c.getElementsByTagName("rt");u=Array.from(e).map((e=>replaceNumbers(e.textContent.toLowerCase()))).join(" ")}let g=!1;if(n||a||i||o)t.forEach((t=>{if(a&&(l.includes(t.hiragana)||l.includes(t.katakana))&&(g=!0),n&&(u.includes(t.hiragana)||u.includes(t.katakana))&&(g=!0),i){new RegExp(`\\b${e.toLowerCase()}\\b`,"i").test(d)&&(g=!0)}}));else{const e=c.getElementsByTagName("ruby");let n=c.textContent.toLowerCase();Array.from(e).forEach((e=>{const t=e.textContent;n=n.replace(t,e.childNodes[0].textContent)})),n=replaceNumbers(n),t.forEach((e=>{const t=e.hiragana+"|"+e.katakana;new RegExp(t,"g");(n.includes(e.hiragana)||n.includes(e.katakana))&&(g=!0)}))}g&&(filteredData.push(r),s++)})),loadPage(currentPage),updateCounter();const r=document.getElementsByClassName("exercise");let c=[];for(let s=0;s<r.length;s++){const l=r[s],d=l.getElementsByClassName("sentence")[0],u=l.getElementsByClassName("translation")[0];if(!d||!u)continue;const g=replaceNumbers(d.textContent.toLowerCase()),m=replaceNumbers(u.textContent.toLowerCase());let h="";if(n){const e=d.getElementsByTagName("rt");for(let t=0;t<e.length;t++)h+=replaceNumbers(e[t].textContent.toLowerCase())}let f=!1;if(n||a||i||o)t.forEach((t=>{a&&(g.includes(t.hiragana)||g.includes(t.katakana))&&(f=!0),n&&(h.includes(t.hiragana)||h.includes(t.katakana))&&(f=!0),i&&m.includes(e.toLowerCase())&&(f=!0)}));else{const e=d.cloneNode(!0),n=e.getElementsByTagName("rt");for(;n.length>0;)n[0].parentNode.removeChild(n[0]);const a=replaceNumbers(e.textContent.toLowerCase());t.forEach((e=>{(a.includes(e.hiragana)||a.includes(e.katakana))&&(f=!0)}))}f&&(c.push({element:d,text:g}),c.push({element:u,text:m}))}determineHighlightFunction(n,a)(c,t.flatMap((t=>[t.hiragana,t.katakana,e.toLowerCase()]))),document.getElementById("filteredNumber").innerText=s||"(•́︵•̀)"}function determineHighlightFunction(e,t){return e&&t?highlightMatchesFuriganaKanji:highlightMatchesDefault}function highlightMatchesDefault(e,t){const n=new RegExp(`(${t.join("|")})`,"gi");e.forEach((({element:e,text:t})=>{let a=e.getAttribute("data-original-content")||e.innerHTML;const i=a.replace(n,'<span class="highlight">$1</span>');i!==e.innerHTML&&(e.innerHTML=i),e.hasAttribute("data-original-content")||e.setAttribute("data-original-content",a)}))}function highlightMatchesFuriganaKanji(){const e=document.getElementById("search").value,t=e.charAt(0),n=e.slice(1);document.querySelectorAll("ruby").forEach((e=>{const a=e.querySelector("rt");if(a){const i=a.textContent;3===e.childNodes[0].nodeType&&e.childNodes[0].nodeValue.trim()===t&&i===n?e.classList.add("highlight"):e.classList.remove("highlight")}}))}const kanjiIndex=readings.reduce(((e,t)=>(t.ja_on.concat(t.ja_kun).forEach((n=>{const a=wanakana.toHiragana(n);e[a]||(e[a]=[]),e[a].push(t)})),e)),{});function kanjiSearchFunction(){const e=document.getElementById("search"),t=wanakana.toHiragana(e.value.trim()),n=kanjiIndex[t]?[...kanjiIndex[t]]:[];"まるばつ"===t&&n.push({literal:"〇"},{literal:"×"});const a=document.getElementById("kanjiFoundContainer");a.innerHTML="";const i=document.createDocumentFragment();n.forEach((t=>{const n=document.createElement("div");n.textContent=t.literal,n.classList.add("kanji"),n.addEventListener("click",(()=>{e.value="",e.value+=n.textContent,debounceSearch()})),i.appendChild(n)})),a.appendChild(i)}function bindIME(){const e=document.getElementById("search");wanakana.bind(e,{IMEMode:IMEMode}),isBound=!0}function unbindIME(){const e=document.getElementById("search");wanakana.unbind(e),isBound=!1}function toggleIMEMode(){IMEMode="toHiragana"===IMEMode?"toKatakana":"toHiragana",isBound&&bindIME()}function handleCheckboxChange(){document.getElementById("useFurigana").checked;const e=document.getElementById("useTranslation").checked,t=document.getElementById("useLessons").checked;e||t?isBound&&unbindIME():isBound||bindIME(),searchFunction()}function clearElementHighlight(e){e&&e.hasAttribute("data-original-content")&&(e.innerHTML=e.getAttribute("data-original-content"),e.removeAttribute("data-original-content"))}function toggleVisibility(e){"RUBY"===e.target.tagName||e.target.closest("ruby")?handleRubyVisibility(e):e.target.classList.contains("close-note")?handleCloseNoteVisibility(e):e.target.classList.contains("notes")&&handleNotesVisibility(e)}function handleRubyVisibility(e){const t=e.target.closest("ruby").getElementsByTagName("rt");for(const e of t)e.style.visibility="hidden"===e.style.visibility?"visible":"hidden"}function handleCloseNoteVisibility(e){e.target.closest(".notes").innerHTML="Show notes"}function handleNotesVisibility(e){const t=e.target,n=t.getAttribute("data-original-text");t.innerHTML=`${n} <span class="close-note">Close</span>`}function displayChapter(e){const t=document.getElementById("useLessons").checked,n=document.getElementById("search").value.trim();if(!t||""===n)return filteredData=e,void loadPage(1);const a=chapters[n];if(a){const t=parseInt(a.start_id),n=parseInt(a.end_id);filteredData=e.filter((e=>{const a=parseInt(e.id);return a>=t&&a<=n}))}else filteredData=[];loadPage(1),updateCounter()}